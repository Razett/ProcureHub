<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{/base/base::setContent(~{this::content})}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <title>Home</title>
    <style>
      /* Loader 스타일 */
      #loader {
        transition: all 0.3s ease-in-out;
        opacity: 1;
        visibility: visible;
        position: fixed;
        height: 100vh;
        width: 100%;
        background: #fff;
        z-index: 90000;
      }
      #loader.fadeOut {
        opacity: 0;
        visibility: hidden;
      }
      .spinner {
        width: 40px;
        height: 40px;
        position: absolute;
        top: calc(50% - 20px);
        left: calc(50% - 20px);
        background-color: #333;
        border-radius: 100%;
        -webkit-animation: sk-scaleout 1.0s infinite ease-in-out;
        animation: sk-scaleout 1.0s infinite ease-in-out;
      }
      @-webkit-keyframes sk-scaleout {
        0% { -webkit-transform: scale(0) }
        100% {
          -webkit-transform: scale(1.0);
          opacity: 0;
        }
      }
      @keyframes sk-scaleout {
        0% {
          -webkit-transform: scale(0);
          transform: scale(0);
        }
        100% {
          -webkit-transform: scale(1.0);
          transform: scale(1.0);
          opacity: 0;
        }
      }
    </style>
    <script src="js/main.js"></script>
    <link href="css/style.css" rel="stylesheet">
  </head>
  <body class="app">
  <div id="loader">
    <div class="spinner"></div>
  </div>
  <script>
    window.addEventListener('load', function load() {
      const loader = document.getElementById('loader');
      setTimeout(function() {
        loader.classList.add('fadeOut');
      }, 300);
    });
  </script>

  <!-- #Main ============================ -->
  <div class="page-container">
    <main class="main-content bgc-grey-100">
      <input type="hidden" id="id" value="">
      <div id="mainContent">
        <div class="full-container">
          <th:block th:fragment="content">
            <style>
              /* FullCalendar 날짜와 요일 색상 스타일링 */
              .fc-daygrid-day-number, .fc-col-header-cell-cushion {
                color: #000000;
              }
            </style>
            <div class="row">
              <!-- Main Content -->
              <div class="bgc-white p-20 bd">
                <div class="col-md-10">
                  <div class="container mt-4">
                    <div class="row">
                      <div class="col-md-3">
                        <div class="card">
                          <div class="card-body">
                            <h5 class="card-title">조달 계획</h5>
                            <p class="card-text">조달 계획: 329건</p>
                            <p class="card-text">조달 완료: 320건</p>
                          </div>
                        </div>
                      </div>
                      <!-- 다른 카드들 추가 -->
                    </div>
                    <div class="row mt-4">
                      <div class="col-md-8">
                        <div class="card">
                          <div class="card-body">
                            <h5 class="card-title">생산 계획</h5>
                            <div class="calendar">
                              <div id='calendar'></div>
                              <div class="container mt-5">
                                <button type="button" class="btn cur-p btn-dark btn-color" data-bs-toggle="modal" data-bs-target="#eventModal">
                                  일정 추가
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="card mb-4">
                          <div class="card-body">
                            <h5 class="card-title">이번달 진행률</h5>
                            <div class="peer">
                              <div class="easy-pie-chart" data-size="80" data-percent="50" data-bar-color="#2196f3">
                                <span>50 %</span>
                                <canvas height="80" width="80"></canvas></div>
                            </div>
                          </div>
                        </div>
                        <div class="card" id="detailCard">
                          <div class="card-body">
                            <h5 class="card-title">상세보기</h5>
                            <p>날짜를 선택하세요</p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 일정 추가 모달 -->
                    <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="eventModalLabel">일정 추가</h5>
                          </div>
                          <div class="modal-body">
                            <form id="eventForm">
                              <div class="mb-3">
                                <label for="title" class="form-label">일정 제목</label>
                                <input type="text" class="form-control" id="title" required>
                              </div>
                              <div class="mb-3">
                                <label for="startDate" class="form-label">시작 날짜</label>
                                <input type="datetime-local" class="form-control" id="startDate" required>
                              </div>
                              <div class="mb-3">
                                <label for="endDate" class="form-label">종료 날짜</label>
                                <input type="datetime-local" class="form-control" id="endDate" required>
                              </div>
                              <button type="submit" class="btn cur-p btn-dark btn-color">저장</button>
                              <button type="button" class="btn btn-danger" id="deleteEvent" style="display: none;">삭제</button> <!-- 삭제 버튼 -->
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div> <!-- End Main Content -->
            </div>
            <script>
              let calendar;
              let currentEvent;

              $(document).ready(function () {
                var calendarEl = document.getElementById('calendar');
                var deleteButton = $('#deleteEvent');

                const colors = ['#D3C2E6', '#FBC5D8', '#F8A8C9', '#BDDFF5', '#9EC8EB', '#89a5ea', '#a5ea89', '#ffcb6b', '#FFFAF0', '#FFFACD'];

                // FullCalendar 초기화
                calendar = new FullCalendar.Calendar(calendarEl, {
                  initialView: 'dayGridMonth',
                  locale: 'ko',
                  editable: false,
                  eventTextColor: '#000000',

                  // 날짜 클릭 시 상세보기 처리
                  dateClick: function(info) {
                    const clickedDate = info.dateStr;
                    const events = calendar.getEvents().filter(event => {
                      const eventDate = event.start.toISOString().split('T')[0];
                      return eventDate === clickedDate;
                    });

                    let detailsHtml = `<h5 class="card-title">상세보기</h5><p>${clickedDate}</p>`;
                    if (events.length > 0) {
                      events.forEach(event => {
                        detailsHtml += `<p>일정 제목: ${event.title}</p>`;
                      });
                    } else {
                      detailsHtml += `<p>이 날짜에 일정이 없습니다.</p>`;
                    }

                    $('#detailCard .card-body').html(detailsHtml);
                  },

                  // 서버에서 이벤트 데이터를 가져오는 처리
                  events: function (fetchInfo, successCallback, failureCallback) {
                    // prdcPlans 엔드포인트에서 데이터를 가져옴
                    $.ajax({
                      url: '/api/Calendar/prdcPlans',
                      method: 'GET',
                      success: function (data) {
                        const prdcPlanEvents = data.map(plan => {
                          return {
                            id: plan.planNo,
                            title: `생산 수량: ${plan['quantity+']}`,
                            start: plan.start,
                            end: plan.end,
                            backgroundColor: colors[Math.floor(Math.random() * colors.length)],
                          };
                        });

                        // read 엔드포인트에서 데이터를 가져옴
                        $.ajax({
                          url: '/api/Calendar/read',
                          method: 'GET',
                          success: function (data) {
                            const calendarEvents = data.map(event => {
                              return {
                                id: event.id,
                                title: event.title,
                                start: event.start,
                                end: event.end,
                                backgroundColor: colors[Math.floor(Math.random() * colors.length)],
                              };
                            });

                            // prdcPlanEvents와 calendarEvents를 합쳐서 전달
                            successCallback([...prdcPlanEvents, ...calendarEvents]);
                          },
                          error: function (xhr, status, error) {
                            console.error('Error fetching calendar events:', error);
                            failureCallback(error);
                          }
                        });
                      },
                      error: function (xhr, status, error) {
                        console.error('Error fetching prdcPlans:', error);
                        failureCallback(error);
                      }
                    });
                  },

                  eventContent: function (arg) {
                    let title = arg.event.title;
                    let contentEl = document.createElement('div');
                    contentEl.innerHTML = `<b>${title}</b>`;
                    return { domNodes: [contentEl] };
                  },

                  eventDidMount: function(info) {
                    $(info.el).css({
                      'background-color': info.event.backgroundColor + ' !important',
                      'border-color': info.event.borderColor + ' !important'
                    });
                  },

                  eventClick: function (info) {
                    var eventModalEl = $('#eventModal');
                    var eventModal = new bootstrap.Modal(eventModalEl[0]);

                    currentEvent = info.event;

                    deleteButton.show(); // 수정 모달에서는 삭제 버튼을 표시

                    $('#eventModalLabel').text('일정 수정');
                    $('#title').val(info.event.title);
                    $('#startDate').val(info.event.start.toISOString().slice(0, 16));
                    $('#endDate').val(info.event.end ? info.event.end.toISOString().slice(0, 16) : '');

                    eventModal.show();
                  }
                });

                calendar.render();

                $('[data-bs-target="#eventModal"]').on('click', function () {
                  currentEvent = null;
                  $('#eventModalLabel').text('일정 추가');
                  $('#eventForm')[0].reset();
                  deleteButton.hide();
                });

                $('#eventModal').on('hidden.bs.modal', function () {
                  var modalBackdrop = $('.modal-backdrop');
                  if (modalBackdrop.length) {
                    modalBackdrop.remove();
                  }
                });

                function closeModal() {
                  var eventModalEl = $('#eventModal');
                  var eventModal = bootstrap.Modal.getInstance(eventModalEl[0]);
                  if (eventModal) {
                    eventModal.hide();
                    $('body').removeClass('modal-open');
                    var modalBackdrop = $('.modal-backdrop');
                    if (modalBackdrop.length) {
                      modalBackdrop.remove();
                    }
                  }
                }

                // 이벤트 폼 제출 처리 (추가 또는 수정)
                $('#eventForm').on('submit', function (e) {
                  e.preventDefault();

                  const title = $('#title').val();
                  const start = $('#startDate').val();
                  let end = $('#endDate').val();

                  if (!end || start === end) {
                    end = null;
                  } else {
                    end += ':00';
                  }

                  const startWithTime = start + ':00';

                  const randomColor = colors[Math.floor(Math.random() * colors.length)];

                  const event = {
                    title: title,
                    startDate: startWithTime,
                    endDate: end,
                    backgroundColor: currentEvent ? currentEvent.backgroundColor : randomColor,
                    borderColor: currentEvent ? currentEvent.borderColor : randomColor
                  };

                  if (currentEvent) {
                    event.id = currentEvent.id;

                    $.ajax({
                      url: '/api/Calendar/update',
                      method: 'POST',
                      contentType: 'application/json',
                      data: JSON.stringify(event),
                      success: function (data) {
                        currentEvent.setProp('title', event.title);
                        currentEvent.setDates(event.startDate, event.endDate);
                        currentEvent.setProp('backgroundColor', event.backgroundColor);
                        currentEvent.setProp('borderColor', event.borderColor);
                        alert('일정이 수정되었습니다.');
                        closeModal();
                      },
                      error: function (xhr, status, error) {
                        console.error('Error updating event:', error);
                        console.log('서버 응답:', xhr.responseText);
                      }
                    });
                  } else {
                    $.ajax({
                      url: '/api/Calendar/add',
                      method: 'POST',
                      contentType: 'application/json',
                      data: JSON.stringify(event),
                      success: function (data) {
                        const newEvent = calendar.addEvent({
                          id: data.id,
                          title: event.title,
                          start: event.startDate,
                          end: event.endDate,
                          allDay: !event.endDate,
                          backgroundColor: event.backgroundColor,
                          borderColor: event.borderColor
                        });

                        console.log("새로운 이벤트 추가:", newEvent.title, newEvent.backgroundColor);
                        calendar.render();
                        alert('일정이 추가되었습니다.');
                        closeModal();
                      },
                      error: function (xhr, status, error) {
                        console.error('Error adding event:', error);
                        console.log('서버 응답:', xhr.responseText);
                      }
                    });
                  }
                });

                deleteButton.on('click', function () {
                  if (currentEvent) {
                    $.ajax({
                      url: '/api/Calendar/delete',
                      method: 'POST',
                      contentType: 'application/json',
                      data: JSON.stringify({ id: currentEvent.id }),
                      success: function () {
                        currentEvent.remove();
                        localStorage.removeItem(`event-${currentEvent.id}`);
                        alert('일정이 삭제되었습니다.');
                        closeModal();
                      },
                      error: function (xhr, status, error) {
                        console.error('Error deleting event:', error);
                      }
                    });
                  }
                });
              });
            </script>

          </th:block>
        </div> <!-- End Container -->
      </div>
    </main>
    <footer class="bdT ta-c p-30 lh-0 fsz-sm c-grey-600">
      <span>Copyright © 2021 Designed by <a href="https://colorlib.com" target="_blank" title="Colorlib">Colorlib</a>. All rights reserved.</span>
    </footer>
  </div>

  </body>
</th:block>
</html>
