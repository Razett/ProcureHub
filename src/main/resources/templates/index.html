<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{/base/base::setContent(~{this::content})}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <title>Home</title>
    <style>
      /* 요일 텍스트 색상 변경 */
      .fc-col-header-cell-cushion {
        color: #000000 !important;
      }

      /* 날짜 텍스트 색상 변경 */
      .fc-daygrid-day-number {
        color: #000000 !important;
      }

      /* Loader 스타일 */
      #loader {
        transition: all 0.3s ease-in-out;
        opacity: 1;
        visibility: visible;
        position: fixed;
        height: 100vh;
        width: 100%;
        background: #fff;
        z-index: 90000;
      }
      #loader.fadeOut {
        opacity: 0;
        visibility: hidden;
      }
      .spinner {
        width: 40px;
        height: 40px;
        position: absolute;
        top: calc(50% - 20px);
        left: calc(50% - 20px);
        background-color: #333;
        border-radius: 100%;
        -webkit-animation: sk-scaleout 1.0s infinite ease-in-out;
        animation: sk-scaleout 1.0s infinite ease-in-out;
      }
      @-webkit-keyframes sk-scaleout {
        0% { -webkit-transform: scale(0) }
        100% {
          -webkit-transform: scale(1.0);
          opacity: 0;
        }
      }
      @keyframes sk-scaleout {
        0% {
          -webkit-transform: scale(0);
          transform: scale(0);
        }
        100% {
          -webkit-transform: scale(1.0);
          transform: scale(1.0);
          opacity: 0;
        }
      }


      /* 카드 스타일 */
      .card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 16px;
        background-color: #fff;
        width: 250px;
      }

      .card h5 {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 8px;
      }

      .card .item {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .card .item:last-child {
        margin-bottom: 0;
      }

      .card .icon {
        font-size: 24px;
        margin-right: 8px;
      }

      .card .text {
        font-size: 14px;
      }

      .card .text strong {
        display: block;
        margin-bottom: 4px;
        font-weight: bold;
      }

      .card .text p {
        margin: 0;
        line-height: 1.5;
      }

      /* 진행률 텍스트 위치 수정 */
      .easy-pie-chart span {
        display: inline-block;
        transform: translateX(10px); /* 오른쪽으로 이동 */
      }

    </style>
    <script src="js/main.js"></script>
    <link href="css/style.css" rel="stylesheet">
  </head>
  <body class="app">
  <div id="loader">
    <div class="spinner"></div>
  </div>
  <script>
    window.addEventListener('load', function load() {
      const loader = document.getElementById('loader');
      setTimeout(function() {
        loader.classList.add('fadeOut');
      }, 300);
    });
  </script>

  <!-- #Main ============================ -->
  <div class="page-container">
    <main class="main-content bgc-grey-100">
      <input type="hidden" id="id" value="">
      <div id="mainContent">
        <div class="full-container">
          <th:block th:fragment="content">
            <div class="row">
              <!-- Main Content -->
              <div class="bgc-white p-20 bd">
                <div class="col-md-10">
                  <div class="container mt-4">
                    <div class="row">
                      <div class="col-md-3">
                        <div class="card">
                          <h5>조달 계획 현황</h5>
                          <div class="item">
                            <div class="text">
                              <strong>당일 확인 필요한 조달계획 :</strong> 1건
                            </div>
                          </div>
                          <div class="item">
                            <div class="text">
                              <strong>조달 계획</strong>
                              <p>조달계획 완료: 32924건</p>
                              <p>조달계획 미완료: 3204298건</p>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card">
                          <h5>발주 현황</h5>
                          <div class="item">
                            <div class="text">
                              <strong>당일 확인 필요한 발주 : </strong> 1건
                            </div>
                          </div>
                          <div class="item">
                            <div class="text">
                              <strong>발주</strong>
                              <p>발주 수: 3908건</p>
                              <p>진행중: 392건</p>
                              <p>완료: 29건</p>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card">
                          <h5>입고 현황</h5>
                          <div class="item">
                            <div class="text">
                              <strong>당일 확인 필요한 입고 : </strong> 1건
                            </div>
                          </div>
                          <div class="item">
                            <div class="text">
                              <strong>입고</strong>
                              <p>총 입고수: 100개</p>
                              <p>진행중: 10개</p>
                              <p>완료: 90개</p>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card">
                          <h5>출고 현황</h5>
                          <div class="item">
                            <div class="text">
                              <strong>당일 확인 필요한 출고 : </strong> 1건
                            </div>
                          </div>
                          <div class="item">
                            <div class="text">
                              <strong>출고</strong>
                              <p>출고 수: 21개</p>
                              <p>진행중: 19개</p>
                              <p>완료: 2개</p>
                            </div>
                          </div>
                        </div>
                      </div>
                      <!-- 다른 카드들 추가 -->
                    </div>
                    <div class="row mt-4">
                      <div class="col-md-8">
                        <div class="card">
                          <div class="card-body">
                            <h5 class="card-title">생산 계획</h5>
                            <div class="calendar">
                              <div id='calendar'></div>
                              <div class="container mt-5">
                                <button type="button" class="btn cur-p btn-dark btn-color" data-bs-toggle="modal" data-bs-target="#eventModal">
                                  생산 추가
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="card bg-light shadow-sm rounded-3" id="detailCard" style="border: none;">
                          <div class="card-body">
                            <h5 class="card-title text-info">상세보기</h5>
                            <p class="text-secondary">날짜를 선택하세요</p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 생산 추가 모달 -->
                    <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="eventModalLabel">생산 계획 추가</h5>
                          </div>
                          <div class="modal-body">
                            <form id="eventForm">
                              <div class="mb-3">
                                <label for="prdcNo" class="form-label">자재 선택</label>
                                <select id="prdcNo" class="form-control" required>
                                  <!-- 자재 옵션을 여기에 추가 -->
                                </select>
                                <div class="mb-3">
                                  <label class="form-label">제품명</label>
                                  <p id="prdcName"></p>  <!-- 제품명이 표시될 곳 -->
                                </div>
                              </div>
                              <div class="mb-3">
                                <label for="quantity" class="form-label">수량</label>
                                <input type="number" class="form-control" id="quantity" required>
                              </div>
                              <div class="mb-3">
                                <label for="startDate" class="form-label">시작 날짜</label>
                                <input type="datetime-local" class="form-control" id="startDate" required>
                              </div>
                              <div class="mb-3">
                                <label for="endDate" class="form-label">종료 날짜</label>
                                <input type="datetime-local" class="form-control" id="endDate" required>
                              </div>
                              <button type="submit" class="btn cur-p btn-dark btn-color">저장</button>
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 수정 모달 -->
                    <div class="modal fade" id="editPrdcPlanModal" tabindex="-1" aria-labelledby="editPrdcPlanModalLabel" aria-hidden="true">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="editPrdcPlanModalLabel">생산 계획 수정</h5>
                          </div>
                          <div class="modal-body">
                            <form id="editPrdcPlanForm">
                              <div class="mb-3">
                                <label for="editPrdcName" class="form-label">자재 이름</label>
                                <input type="text" class="form-control" id="editPrdcName" readonly> <!-- 이름 읽기 전용 -->
                              </div>
                              <div class="mb-3">
                                <label for="editStartDate" class="form-label">시작 날짜</label>
                                <input type="datetime-local" class="form-control" id="editStartDate" readonly> <!-- 시작 날짜 읽기 전용 -->
                              </div>
                              <div class="mb-3">
                                <label for="editEndDate" class="form-label">종료 날짜</label>
                                <input type="datetime-local" class="form-control" id="editEndDate" readonly> <!-- 종료 날짜 읽기 전용 -->
                              </div>
                              <div class="mb-3">
                                <label for="editQuantity" class="form-label">수량</label>
                                <input type="number" class="form-control" id="editQuantity" required> <!-- 수량 수정 가능 -->
                              </div>
                              <button type="submit" class="btn cur-p btn-dark btn-color">수정</button>
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>




                  </div>
                </div>
              </div> <!-- End Main Content -->
            </div>
            <style>
              /* FullCalendar 날짜와 요일 색상 스타일링 */
              .fc-daygrid-day-number, .fc-col-header-cell-cushion {
                color: #000000 !important;
              }
            </style>
            <script>
              let calendar;
              let currentEvent;

              $(document).ready(function () {
                var calendarEl = document.getElementById('calendar');
                var deleteButton = $('#deleteEvent');

                const colors = ['#D3C2E6', '#FBC5D8', '#F8A8C9', '#BDDFF5', '#9EC8EB', '#89a5ea', '#a5ea89', '#ffcb6b', '#FFFAF0', '#FFFACD'];

                $.ajax({
                  url: '/api/Calendar/all',
                  method: 'GET',
                  success: function (data) {
                    const prdcSelect = $('#prdcNo');
                    data.forEach(prdc => {
                      prdcSelect.append(new Option(prdc.name, prdc.prdcno));
                    });
                  },
                  error: function (xhr, status, error) {
                    console.error('Error fetching prdc data:', error);
                    alert('자재 목록을 불러오는 데 실패했습니다.');
                  }
                });

                // prdcNo 선택 시 제품명 자동으로 가져오기
                $('#prdcNo').change(function() {
                  const selectedPrdcNo = $(this).val();
                  $.ajax({
                    url: `/api/Calendar/${selectedPrdcNo}`,
                    method: 'GET',
                    success: function (data) {
                      $('#prdcName').text(data.name);  // 제품명을 표시할 요소
                    },
                    error: function (xhr, status, error) {
                      console.error('Error fetching product name:', error);
                      alert('제품명을 불러오는 데 실패했습니다.');
                    }
                  });
                });

                // FullCalendar 초기화
                calendar = new FullCalendar.Calendar(calendarEl, {
                  initialView: 'dayGridMonth',
                  locale: 'ko',
                  editable: false,
                  eventTextColor: '#000000',

                  // 날짜 클릭 시 상세보기 처리
                  dateClick: function (info) {
                    const clickedDate = info.dateStr;
                    const events = calendar.getEvents().filter(event => {
                      const eventStartDate = event.start.toISOString().split('T')[0];
                      const eventEndDate = event.end ? event.end.toISOString().split('T')[0] : eventStartDate;

                      // 클릭한 날짜가 이벤트의 시작 날짜와 종료 날짜 사이에 있는지 확인
                      return clickedDate >= eventStartDate && clickedDate <= eventEndDate;
                    });

                    let detailsHtml = `<h5 class="card-title">상세보기</h5><p>${clickedDate}</p>`;
                    if (events.length > 0) {
                      events.forEach(event => {
                        if (event.extendedProps.prdcName) {
                          detailsHtml += `<p>자재 이름: ${event.extendedProps.prdcName}</p>`;
                        }
                        if (event.extendedProps.quantity) {
                          detailsHtml += `<p>수량: ${event.extendedProps.quantity}</p>`;
                        }
                      });
                    } else {
                      detailsHtml += `<p>이 날짜에 일정이 없습니다.</p>`;
                    }

                    $('#detailCard .card-body').html(detailsHtml);
                  },

                  // 서버에서 이벤트 데이터를 가져오는 처리
                  events: function (fetchInfo, successCallback, failureCallback) {
                    // prdcPlans 엔드포인트에서 데이터를 가져옴
                    $.ajax({
                      url: '/api/Calendar/prdcPlans',
                      method: 'GET',
                      success: function (data) {
                        const prdcPlanEvents = data.map(plan => {
                          const eventId = `event-${plan.planNo}`;

                          // 로컬 스토리지에서 색상을 가져옴
                          let storedColors = localStorage.getItem(eventId);
                          let backgroundColor, borderColor;

                          if (storedColors) {
                            const parsedColors = JSON.parse(storedColors);
                            backgroundColor = parsedColors.backgroundColor;
                            borderColor = parsedColors.borderColor;
                          } else {
                            // 색상이 로컬 스토리지에 없으면 새로운 색상을 선택하고 저장
                            backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                            borderColor = backgroundColor;

                            localStorage.setItem(eventId, JSON.stringify({
                              backgroundColor: backgroundColor,
                              borderColor: borderColor
                            }));
                          }

                          return {
                            id: plan.planNo,
                            title: `자재명: ${plan.prdcName}`,
                            start: plan.start,
                            end: plan.end,
                            backgroundColor: backgroundColor,
                            borderColor: borderColor,
                            extendedProps: {
                              prdcName: plan.prdcName,
                              quantity: plan['quantity+']
                            }
                          };
                        });

                        // prdcPlanEvents와 calendarEvents를 합쳐서 전달
                        successCallback(prdcPlanEvents);
                      },
                      error: function (xhr, status, error) {
                        console.error('Error fetching prdcPlans:', error);
                        failureCallback(error);
                      }
                    });
                  },

                  eventContent: function (arg) {
                    let title = arg.event.title;
                    let contentEl = document.createElement('div');
                    contentEl.innerHTML = `<b>${title}</b>`;
                    return { domNodes: [contentEl] };
                  },

                  eventDidMount: function (info) {
                    $(info.el).css({
                      'background-color': info.event.backgroundColor + ' !important',
                      'border-color': info.event.borderColor + ' !important'
                    });
                  },

                  // 이벤트 클릭 시 새로 만든 수정 모달 열기 및 수량 수정
                  eventClick: function (info) {
                    var editPrdcPlanModalEl = $('#editPrdcPlanModal');  // 새로 만든 수정 모달
                    var editPrdcPlanModal = new bootstrap.Modal(editPrdcPlanModalEl[0]);

                    currentEvent = info.event;

                    // 수정 모달에 수량 정보만 설정
                    $('#editPrdcPlanModalLabel').text('생산 계획 수정');
                    $('#editQuantity').val(info.event.extendedProps.quantity); // 수량을 모달에 설정
                    $('#editPrdcName').val(info.event.extendedProps.prdcName); // 자재 이름을 모달에 설정
                    $('#editStartDate').val(info.event.start.toISOString().slice(0, 16)); // 시작 날짜 설정
                    $('#editEndDate').val(info.event.end ? info.event.end.toISOString().slice(0, 16) : ''); // 종료 날짜 설정

                    editPrdcPlanModal.show();

                    // 폼 제출 시 수정된 데이터를 서버로 전송
                    $('#editPrdcPlanForm').off('submit').on('submit', function (e) {
                      e.preventDefault();

                      const prdcPlanData = {
                        prdcPlanNo: currentEvent.id, // ID 대신 prdcPlanNo로 수정
                        quantity: $('#editQuantity').val()
                      };

                      $.ajax({
                        url: '/api/Calendar/updatePrdcPlan',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(prdcPlanData),
                        success: function (data) {
                          alert('생산 계획이 수정되었습니다.');
                          currentEvent.setProp('extendedProps', { quantity: quantity });
                          editPrdcPlanModal.hide();
                        },
                        error: function (xhr, status, error) {
                          console.error('Error updating prdc plan:', error);
                          console.log('서버 응답:', xhr.responseText);
                        }
                      });
                    });
                  }
                });

                calendar.render();

                $('[data-bs-target="#eventModal"]').on('click', function () {
                  currentEvent = null;
                  $('#eventModalLabel').text('일정 추가');
                  $('#eventForm')[0].reset();
                  deleteButton.hide();
                });

                $('#eventModal').on('hidden.bs.modal', function () {
                  var modalBackdrop = $('.modal-backdrop');
                  if (modalBackdrop.length) {
                    modalBackdrop.remove();
                  }
                });

                function closeModal() {
                  var eventModalEl = $('#eventModal');
                  var eventModal = bootstrap.Modal.getInstance(eventModalEl[0]);
                  if (eventModal) {
                    eventModal.hide();
                    $('body').removeClass('modal-open');
                    var modalBackdrop = $('.modal-backdrop');
                    if (modalBackdrop.length) {
                      modalBackdrop.remove();
                    }
                  }
                }

                // 이벤트 폼 제출 처리 (추가 또는 수정)
                $('#eventForm').on('submit', function (e) {
                  e.preventDefault();

                  const prdcNo = $('#prdcNo').val();  // 자재 선택
                  const quantity = $('#quantity').val();
                  const start = $('#startDate').val();
                  let end = $('#endDate').val();

                  if (!end || start === end) {
                    end = null;
                  } else {
                    end += ':00';
                  }

                  const startWithTime = start + ':00';

                  const prdcPlanData = {
                    prdcNo: prdcNo,
                    quantity: quantity,
                    startdate: startWithTime,
                    enddate: end
                  };

                  $.ajax({
                    url: '/api/Calendar/addPrdcPlan',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(prdcPlanData),
                    success: function (data) {
                      console.log("새로운 생산 계획 추가:", data);
                      alert('생산 계획이 추가되었습니다.');
                      closeModal();
                    },
                    error: function (xhr, status, error) {
                      console.error('Error adding prdc plan:', error);
                      console.log('서버 응답:', xhr.responseText);
                    }
                  });
                });

                deleteButton.on('click', function () {
                  if (currentEvent) {
                    $.ajax({
                      url: '/api/Calendar/deletePrdcPlan',
                      method: 'POST',
                      contentType: 'application/json',
                      data: JSON.stringify({ id: currentEvent.id }),
                      success: function () {
                        currentEvent.remove();
                        localStorage.removeItem(`event-${currentEvent.id}`);
                        alert('일정이 삭제되었습니다.');
                        closeModal();
                      },
                      error: function (xhr, status, error) {
                        console.error('Error deleting event:', error);
                      }
                    });
                  }
                });
              });
            </script>

          </th:block>
        </div> <!-- End Container -->
      </div>
    </main>
    <footer class="bdT ta-c p-30 lh-0 fsz-sm c-grey-600">
      <span>Copyright © 2021 Designed by <a href="https://colorlib.com" target="_blank" title="Colorlib">Colorlib</a>. All rights reserved.</span>
    </footer>
  </div>

  </body>
</th:block>
</html>
